# main.py - –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
import os
import time
import sqlite3
from dotenv import load_dotenv
from bot.bot import run_bot
from utils.database_recovery import recover_database

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ —á–∏—Å—Ç–æ–≥–æ –≤–∞–≤–∏–ª–æ–Ω—Å–∫–æ–≥–æ –±–æ—Ç–∞"""
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    load_dotenv()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞
    if not os.getenv('BOT_TOKEN'):
        print("‚ùå –û—à–∏–±–∫–∞: BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ")
        print("üí° –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env –∏ –¥–æ–±–∞–≤—å—Ç–µ: BOT_TOKEN=your_actual_token")
        return
    
    # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    print("üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")
    recover_database()
    
    print("üöÄ –ó–∞–ø—É—Å–∫ –í–∞–≤–∏–ª–æ–Ω—Å–∫–æ–≥–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –±–æ—Ç–∞...")
    print("üíé –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: –ß–∏—Å—Ç–∞—è –≤–∞–≤–∏–ª–æ–Ω—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è")
    print("üìä –ü—Ä–∞–≤–∏–ª–∞: –ì–∏–±–∫–∏–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è (0-100%), –±—é–¥–∂–µ—Ç—ã, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ")
    print("üéØ –¶–µ–ª—å: –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –º—É–¥—Ä–æ—Å—Ç—å –ø–æ –∑–∞–∫–æ–Ω–∞–º –¥—Ä–µ–≤–Ω–µ–≥–æ –í–∞–≤–∏–ª–æ–Ω–∞")
    
    try:
        run_bot()
    except sqlite3.OperationalError as e:
        if "database is locked" in str(e):
            print("üîí –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...")
            time.sleep(5)
            recover_database()
            run_bot()
        else:
            raise e
    except KeyboardInterrupt:
        print("\nüõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")

if __name__ == '__main__':
    main()