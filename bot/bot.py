# bot/bot.py

import os
import logging
from telegram.ext import Application, CommandHandler, MessageHandler, filters

from .handlers import (
    start, 
    handle_menu_commands, 
    handle_analytics_commands,
    handle_visualizations_commands
)
from .conversations import create_transaction_conversation_handler
from .debt_conversations import create_debt_conversation_handler
from .debt_handlers import create_debt_payment_conversation_handler
from .debt_menu_handlers import handle_debt_menu_commands

logger = logging.getLogger(__name__)

def setup_bot():
    """–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –±–æ—Ç–∞ —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –§–∞–∑—ã 3"""
    BOT_TOKEN = os.getenv('BOT_TOKEN')
    
    if not BOT_TOKEN:
        raise ValueError("BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")
    
    application = Application.builder().token(BOT_TOKEN).build()
    
    # üìç –í–ê–ñ–ù–û: –ü–æ—Ä—è–¥–æ–∫ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –∫ –æ–±—â–∏–º
    
    # 1. –ö–æ–º–∞–Ω–¥–∞ /start (—Å–∞–º–∞—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è)
    application.add_handler(CommandHandler("start", start))
    
    # 2. Conversation Handlers (–æ—á–µ–Ω—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ)
    application.add_handler(create_transaction_conversation_handler())
    application.add_handler(create_debt_conversation_handler())
    application.add_handler(create_debt_payment_conversation_handler())
    
    # 3. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–µ–Ω—é –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–π (—Å–∞–º—ã–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã)
    visualizations_commands_pattern = r'^(üèîÔ∏è –ü–∏—Ä–∞–º–∏–¥–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏|üèõÔ∏è –•—Ä–∞–º –±–æ–≥–∞—Ç—Å—Ç–≤–∞|üåä –†–µ–∫–∏ —É–¥–∞—á–∏|‚ú® –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø|üìú –ú–µ—Å—è—á–Ω–∞—è –ª–µ—Ç–æ–ø–∏—Å—å|üîô –ù–∞–∑–∞–¥ –∫ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ|üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é)$'
    application.add_handler(MessageHandler(
        filters.Regex(visualizations_commands_pattern), 
        handle_visualizations_commands
    ))
    
    # 4. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–µ–Ω—é –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã)
    analytics_commands_pattern = r'^(üèõÔ∏è –§–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ|üîÆ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π|üìä –ê–Ω–∞–ª–∏–∑ —Ä–∞—Å—Ö–æ–¥–æ–≤|üìà –¢—Ä–µ–Ω–¥—ã –¥–æ—Ö–æ–¥–æ–≤|üéØ –ü–∞—Ç—Ç–µ—Ä–Ω—ã —Ä–∞—Å—Ö–æ–¥–æ–≤|üé® –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏|üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é)$'
    application.add_handler(MessageHandler(
        filters.Regex(analytics_commands_pattern), 
        handle_analytics_commands
    ))
    
    # 5. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–µ–Ω—é –¥–æ–ª–≥–æ–≤ (—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã)
    debt_commands_pattern = r'^(üìú –ú–æ–∏ –¥–æ–ª–≥–∏|‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥–æ–ª–≥|üí≥ –ü–æ–≥–∞—Å–∏—Ç—å –¥–æ–ª–≥|üìã –ü–ª–∞–Ω –ø–æ–≥–∞—à–µ–Ω–∏—è|üìà –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–≤–æ–±–æ–¥—ã|üéØ –í–µ—Ö–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è|üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ–ª–≥–æ–≤|üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é)$'
    application.add_handler(MessageHandler(
        filters.Regex(debt_commands_pattern), 
        handle_debt_menu_commands
    ))
    
    # 6. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –±—ã—Å—Ç—Ä–æ–≥–æ –≤–≤–æ–¥–∞ –¥–æ–ª–≥–æ–≤
    application.add_handler(MessageHandler(
        filters.Regex(r'^–¥–æ–ª–≥ .*'), 
        handle_debt_menu_commands
    ))
    
    # 7. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é (—Å–∞–º—ã–π –æ–±—â–∏–π - –ü–û–°–õ–ï–î–ù–ò–ô)
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_menu_commands))
    
    logger.info("‚úÖ –ë–æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –§–∞–∑—ã 3")
    return application

def run_bot():
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç–∞ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π"""
    try:
        application = setup_bot()
        print("üèõÔ∏è –í–∞–≤–∏–ª–æ–Ω—Å–∫–∏–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç –∑–∞–ø—É—â–µ–Ω")
        print("üìà –§–∞–∑–∞ 3: –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ê–ö–¢–ò–í–ò–†–û–í–ê–ù–ê")
        print("üé® –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:")
        print("   ‚Ä¢ –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤ –¥–æ—Ö–æ–¥–æ–≤")
        print("   ‚Ä¢ –ü–∞—Ç—Ç–µ—Ä–Ω—ã —Ä–∞—Å—Ö–æ–¥–æ–≤") 
        print("   ‚Ä¢ –í–∞–≤–∏–ª–æ–Ω—Å–∫–∏–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏")
        print("   ‚Ä¢ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã")
        print("   ‚Ä¢ –ú–µ—Å—è—á–Ω—ã–µ –æ—Ç—á–µ—Ç—ã")
        application.run_polling()
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: {e}")
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")